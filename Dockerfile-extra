# vim: ft=dockerfile
FROM platypew/pwnpad:latest

ENV USER pwnpad
USER $USER

RUN sudo pacman -R --noconfirm gnu-netcat && \
    sudo pacman -Syu --noconfirm --overwrite='*' arp-scan autorecon commix crackmapexec creddump \
         crunch dbd dns2tcp dnsenum dnsrecon empire enum4linux-ng expect fping hashcat-utils hping \
         inetsim iodine pwnpad/john lbd ligolo-ng ldapenum mimikatz nasm nbtscan ncrack netsed \
         netsniff-ng net-snmp ngrep nikto onesixtyone patator proxychains-ng rbndr rustscan \
         samdump2 scalpel seclists sleuthkit smbmap snmpcheck socat swaks tcpreplay traceroute \
         unix-privesc-check upx wafw00f wce webshells whatweb whois windows-binaries && \
    sudo pacman -Rdd --noconfirm impacket && \
    sudo pip uninstall --break-system-packages -y impacket && \
    yay -S --noconfirm python-impacket-git && \
    for cmd in $(echo "addcomputer.py" "atexec.py" "dcomexec.py" "dpapi.py" "esentutl.py" \
                        "exchanger.py" "findDelegation.py" "GetADUsers.py" "getArch.py" \
                        "Get-GPPPassword.py" "GetNPUsers.py" "getPac.py" "getST.py" "getTGT.py" \
                        "GetUserSPNs.py" "goldenPac.py" "karmaSMB.py" "keylistattack.py" \
                        "kintercept.py" "lookupsid.py" "machine_role.py" "mimikatz.py" \
                        "mqtt_check.py" "mssqlclient.py" "mssqlinstance.py" "netview.py" \
                        "nmapAnswerMachine.py" "ntfs-read.py" "ntlmrelayx.py" "ping.py" "ping6.py" \
                        "psexec.py" "raiseChild.py" "rbcd.py" "rdp_check.py" "reg.py" \
                        "registry-read.py" "rpcdump.py" "rpcmap.py" "sambaPipe.py" "samrdump.py" \
                        "secretsdump.py" "services.py" "smbclient.py" "smbexec.py" "smbpasswd.py" \
                        "smbrelayx.py" "smbserver.py" "sniff.py" "sniffer.py" "split.py" \
                        "ticketConverter.py" "ticketer.py" "wmiexec.py" "wmipersist.py" "wmiquery.py"); do \
        ln -s /usr/bin/$cmd /home/$USER/.local/bin/impacket-$cmd ; \
    done ; \
    sudo pip install --break-system-packages charset_normalizer dsinternals && \
    if [[ "$(uname -m)" == "aarch64" ]]; then \
        sudo find /usr/lib/python3.10/site-packages -maxdepth 1 -type d \
            \( -name 'aardwolf*' -o -name 'arc4*' -o -name 'bitstruct*' \) \
            -exec ln -s -t /usr/lib/python3.11/site-packages {} + && \
        sudo ln -s /usr/lib/python3.10/site-packages/librlers.cpython-310-aarch64-linux-gnu.so \
                   /usr/lib/python3.11/site-packages/librlers.cpython-311-aarch64-linux-gnu.so && \
        sudo ln -s /usr/lib/python3.10/site-packages/arc4.cpython-310-aarch64-linux-gnu.so \
                   /usr/lib/python3.11/site-packages/arc4.cpython-311-aarch64-linux-gnu.so ; \
    fi ; \
    sudo ln -s /opt/ligolo-ng/agent /usr/bin/ligolo-proxy && \
    yes | sudo pacman -Sdd gnu-netcat && \
    sudo pacman -Sdd --noconfirm responder && \
    git clone --depth=1 https://github.com/cwinfosec/revshellgen.git ~/.local/share/revshellgen && \
    chmod +x  ~/.local/share/revshellgen/revshellgen.py && \
    ln -s ~/.local/share/revshellgen/revshellgen.py ~/.local/bin/revshellgen.py && \
    sudo mkdir /etc/samba && \
    sudo wget -O /etc/samba/smb.conf \
         "https://raw.githubusercontent.com/samba-team/samba/master/examples/smb.conf.default" && \
    sudo pacman -S --noconfirm xorg-server-xvfb x11vnc novnc xdotool gnu-free-fonts i3-wm i3status && \
    yay -Scc --noconfirm && yay -Rsc --noconfirm $(yay -Qtdq) || true && \
    sudo mv /usr/share/locale/locale.alias /usr/share/locale/en_US /tmp && \
    sudo rm -rf /usr/share/locale/* && sudo mv /tmp/locale.alias /tmp/en_US /usr/share/locale && \
    sudo rm -rf /home/$USER/.zshrc.pre-oh-my-zsh /home/$USER/.zsh_history /home/$USER/.bash_profile \
         /home/$USER/.wget-hsts /home/$USER/.bash_logout /home/$USER/.bundle /tmp/* /var/cache \
         /home/$USER/.cache/pip /home/$USER/.cache/yay /home/$USER/.npm /var/log/* && \
    sudo updatedb

USER root
