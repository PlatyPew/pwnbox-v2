# vim: ft=dockerfile
FROM platypew/pwnpad:latest

ENV USER pwnpad
USER $USER

# Temporarily uninstall gnu netcat
RUN sudo pacman -R --noconfirm gnu-netcat && \
\
# Install extra software
    sudo pacman -Syu --noconfirm --overwrite='*' arp-scan autorecon commix crackmapexec creddump \
         crunch dbd dns2tcp dnsenum dnsrecon empire enum4linux-ng expect fping hashcat-utils hping \
         inetsim iodine pwnpad/john lbd ligolo-ng ldapenum mimikatz nasm nbtscan ncrack netsed \
         netsniff-ng net-snmp ngrep nikto onesixtyone patator proxychains-ng rbndr rustscan \
         samdump2 scalpel seclists sleuthkit smbmap snmpcheck socat swaks tcpreplay traceroute \
         unix-privesc-check upx wafw00f wce webshells whatweb whois windows-binaries && \
    sudo ln -s /opt/ligolo-ng/agent /usr/bin/ligolo-proxy && \
\
# Fix empire
    printf "%s\n%s\n%s\n%s\n%s\n%s\n%s\n" \
           '#!/bin/sh' \
           "sudo systemctl start mariadb.service || exit" \
           "mysql -u root -e \"CREATE USER IF NOT EXISTS 'empire_user'@'localhost' IDENTIFIED BY 'empire_password';\"" \
           "mysql -u root -e \"GRANT ALL PRIVILEGES ON *.* TO 'empire_user'@'localhost' WITH GRANT OPTION;\"" \
           'mysql -u root -e "FLUSH PRIVILEGES;"' \
           "cd /usr/share/empire" 'exec python empire.py server "$@"' | \
               sudo tee /usr/sbin/empire-server && \
    sudo pip install --break-system-packages \
         uvicorn git+https://github.com/BC-SECURITY/PySecretSOCKS.git donut && \
\
# Fix smbclient
    sudo mkdir /etc/samba && \
    sudo wget -O /etc/samba/smb.conf \
         "https://raw.githubusercontent.com/samba-team/samba/master/examples/smb.conf.default" && \
\
# Install latest version of impacket
    sudo pacman -Rdd --noconfirm impacket && \
    sudo pip uninstall --break-system-packages -y impacket && \
    yay -S --noconfirm python-impacket-git && \
    for cmd in $(echo "addcomputer" "atexec" "dcomexec" "dpapi" "esentutl" "exchanger" \
                      "findDelegation" "GetADUsers" "getArch" "Get-GPPPassword" "GetNPUsers" \
                      "getPac" "getST" "getTGT" "GetUserSPNs" "goldenPac" "karmaSMB" \
                      "keylistattack" "kintercept" "lookupsid" "machine_role" "mimikatz" \
                      "mqtt_check" "mssqlclient" "mssqlinstance" "netview" "nmapAnswerMachine" \
                      "ntfs-read" "ntlmrelayx" "ping" "ping6" "psexec" "raiseChild" "rbcd" \
                      "rdp_check" "reg" "registry-read" "rpcdump" "rpcmap" "sambaPipe" "samrdump" \
                      "secretsdump" "services" "smbclient" "smbexec" "smbpasswd" "smbrelayx" \
                      "smbserver" "sniff" "sniffer" "split" "ticketConverter" "ticketer" "wmiexec" \
                      "wmipersist" "wmiquery"); do \
        ln -s /usr/bin/$cmd.py /home/$USER/.local/bin/impacket-$cmd ; \
    done && \
    sudo pip install --break-system-packages charset_normalizer dsinternals && \
    if [[ "$(uname -m)" == "aarch64" ]]; then \
        sudo find /usr/lib/python3.10/site-packages -maxdepth 1 -type d \
            \( -name 'aardwolf*' -o -name 'arc4*' -o -name 'bitstruct*' \) \
            -exec ln -s -t /usr/lib/python3.11/site-packages {} + && \
        sudo ln -s /usr/lib/python3.10/site-packages/librlers.cpython-310-aarch64-linux-gnu.so \
                   /usr/lib/python3.11/site-packages/librlers.cpython-311-aarch64-linux-gnu.so && \
        sudo ln -s /usr/lib/python3.10/site-packages/arc4.cpython-310-aarch64-linux-gnu.so \
                   /usr/lib/python3.11/site-packages/arc4.cpython-311-aarch64-linux-gnu.so ; \
    fi && \
\
# Reinstall gnu netcat
    yes | sudo pacman -Sdd gnu-netcat && \
\
# Install responder
    sudo pacman -Sdd --noconfirm responder && \
\
# Install reverse shell generator
    git clone --depth=1 https://github.com/pwnpad/revshellgen.git ~/.local/share/revshellgen && \
    ln -s ~/.local/share/revshellgen/revshellgen ~/.local/bin/revshellgen && \
\
# Install gui stuff
    sudo pacman -S --noconfirm xorg-server-xvfb x11vnc novnc xdotool gnu-free-fonts i3-wm i3status && \
\
# Clean up
    yay -Scc --noconfirm && yay -Rsc --noconfirm $(yay -Qtdq) || true && \
    sudo mv /usr/share/locale/locale.alias /usr/share/locale/en_US /tmp && \
    sudo rm -rf /usr/share/locale/* && sudo mv /tmp/locale.alias /tmp/en_US /usr/share/locale && \
    sudo rm -rf /home/$USER/.zshrc.pre-oh-my-zsh /home/$USER/.zsh_history /home/$USER/.bash_profile \
         /home/$USER/.wget-hsts /home/$USER/.bash_logout /home/$USER/.bundle /tmp/* /var/cache \
         /home/$USER/.cache/pip /home/$USER/.cache/yay /home/$USER/.npm /var/log/* && \
    sudo updatedb

USER root
